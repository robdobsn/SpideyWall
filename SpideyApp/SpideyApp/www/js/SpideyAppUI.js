// Generated by CoffeeScript 1.8.0
var SpideyAppUI,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

SpideyAppUI = (function() {
  function SpideyAppUI() {
    this.touchStartJoystick = __bind(this.touchStartJoystick, this);
    this.touchMoveJoystick = __bind(this.touchMoveJoystick, this);
    this.mouseMoveJoystick = __bind(this.mouseMoveJoystick, this);
    this.rebuildUI = __bind(this.rebuildUI, this);
    this.mediaPlayHelper = new MediaPlayHelper({
      click: "assets/click.mp3",
      ok: "assets/blip.mp3",
      fail: "assets/fail.mp3"
    });
    this.origBackdropSize = {
      width: 504,
      height: 720
    };
    $(window).on('orientationchange', (function(_this) {
      return function() {
        _this.rebuildUI();
      };
    })(this));
    $(window).on('resize', (function(_this) {
      return function() {
        _this.rebuildUI();
      };
    })(this));
    return;
  }

  SpideyAppUI.prototype.init = function(spideyWall, restartCallback) {
    this.spideyWall = spideyWall;
    this.restartCallback = restartCallback;
    $("html").css({
      background: "#000000",
      "-webkit-touch-callout": "none",
      "-webkit-user-select": "none",
      "-khtml-user-select": "none",
      "-moz-user-select": "none",
      "-ms-user-select": "none",
      "user-select": "none"
    });
    $("#gameArea").remove();
    $("body").prepend("<div id=\"gameArea\" style=\"border:0;margin:0;padding:0\">\n	<div id=\"gameScore\"\n		style=\"position: absolute; left: 420px; border: 50px; color:white; z-index: 10; \"></div>\n		        <canvas id=\"spideyCanvas\" \n		        	style=\"position: absolute; left: 0px; border: 0px; \"></canvas>\n	<div id=\"spriteOverlay\" \n		        	style=\"position:absolute; ; left: 0px; border: 0px;\">\n	</div>\n	<div id=\"gamebuttons\" style=\"position:absolute;\">\n	</div>\n</div>");
    this.canvas = document.getElementById("spideyCanvas").getContext("2d");
    this.rebuildUI();
  };

  SpideyAppUI.prototype.setResizeCallback = function(resizeCallback) {
    this.resizeCallback = resizeCallback;
  };

  SpideyAppUI.prototype.rebuildUI = function() {
    var origImgRatio, scaleHeight, scaleWidth, screenRatio;
    this.dispHeight = window.innerHeight - 10;
    this.dispWidth = window.innerWidth - 10;
    this.isLandscape = this.dispWidth > this.dispHeight;
    origImgRatio = this.origBackdropSize.width / this.origBackdropSize.height;
    screenRatio = this.dispWidth / this.dispHeight;
    if (origImgRatio < screenRatio) {
      scaleHeight = this.dispHeight;
      scaleWidth = this.dispHeight * origImgRatio;
    } else {
      scaleWidth = this.dispWidth;
      scaleHeight = this.dispWidth / origImgRatio;
    }
    this.joystickSize = scaleWidth / 3;
    this.canvasLeft = (this.dispWidth - scaleWidth) / 2;
    this.canvasTop = (this.dispHeight - scaleHeight) / 2;
    this.canvasWidth = scaleWidth;
    this.canvasHeight = scaleHeight;
    this.scaleFactorX = this.canvasWidth / this.origBackdropSize.width;
    this.scaleFactorY = this.canvasHeight / this.origBackdropSize.height;
    $("#spideyCanvas").prop({
      "width": this.canvasWidth,
      "height": this.canvasHeight
    });
    $("#spideyCanvas").css({
      "left": this.canvasLeft + "px",
      "top": this.canvasTop + "px",
      "width": this.canvasWidth + "px",
      "height": this.canvasHeight + "px"
    });
    $("#spriteOverlay").css({
      "left": this.canvasLeft + "px",
      "top": this.canvasTop + "px",
      "width": this.canvasWidth + "px",
      "height": this.canvasHeight + "px"
    });
    $("#gamebuttons").css({
      "left": this.canvasLeft + 10 + "px",
      "top": this.canvasTop + (0.76 * this.canvasHeight) + "px",
      "width": this.joystickSize + "px",
      "height": this.joystickSize + "px"
    });
    $("#gameScore").css({
      "left": this.canvasLeft + this.canvasWidth * 0.70 + "px",
      "top": this.canvasTop + (0.06 * this.canvasHeight) + "px",
      "width": 140 + "px",
      "font-size": 50 + "px",
      "font-family": 'Calligraffitti'
    });
    this.showGameBackdrop();
    if (this.resizeCallback != null) {
      this.resizeCallback();
    }
    if (typeof testtest !== "undefined" && testtest !== null) {
      this.canvas.fillStyle = "black";
      this.canvas.fillRect(0, 0, this.canvasWidth, this.canvasHeight);
      this.canvas.fillStyle = "green";
      this.canvas.fillRect(400, 700, 20, 20);
      $("#spriteOverlay").append("<div id=\"dot_0000\"\n	style=\"position:absolute; visibility:visible; left:400px; top:700px\" >\n			        <svg width=\"20px\" height=\"20px\">\n			             <circle cx=\"10\" cy=\"10\" r=\"10\" stroke=\"black\" stroke-width=\"0\" fill=\"yellow\"/>\n			        </svg>\n			    </div>");
    }
  };

  SpideyAppUI.prototype.getPositionOfSprite = function(xyInSpideyWallUnits) {
    var xyOfSprite;
    xyOfSprite = {
      x: xyInSpideyWallUnits.x * this.scaleFactorX,
      y: xyInSpideyWallUnits.y * this.scaleFactorY
    };
    return xyOfSprite;
  };

  SpideyAppUI.prototype.getSpideyWallCoords = function(xyInSpriteUnits) {
    var xyOfSpidey;
    xyOfSpidey = {
      x: xyInSpriteUnits.x / this.scaleFactorX,
      y: xyInSpriteUnits.y / this.scaleFactorY
    };
    return xyOfSpidey;
  };

  SpideyAppUI.prototype.setDirectionCallback = function(directionCallback) {
    this.directionCallback = directionCallback;
  };

  SpideyAppUI.prototype.updateJoystickBallUI = function(joystickDirn, joystickDist) {
    var ballMarginX, ballMarginY, ballMoveRadius, ballOffset, ballSize, dirnInRads;
    if (joystickDist == null) {
      joystickDist = 100;
    }
    ballSize = this.joystickSize / 2;
    ballMarginX = this.joystickSize / 2 - ballSize / 2;
    ballMarginY = this.joystickSize / 2 - ballSize / 2;
    ballMoveRadius = this.joystickSize / 5;
    if (joystickDirn != null) {
      dirnInRads = joystickDirn * Math.PI / 180;
      ballOffset = Math.min(joystickDist, ballMoveRadius);
      ballMarginX += Math.cos(dirnInRads) * ballOffset;
      ballMarginY += Math.sin(dirnInRads) * ballOffset;
    }
    $("#sqJoystickBall img").css({
      "margin-left": ballMarginX + "px",
      "margin-top": ballMarginY + "px",
      "width": ballSize + "px",
      "height": ballSize + "px"
    });
  };

  SpideyAppUI.prototype.mouseMoveJoystick = function(event) {
    var ballCentreX, ballCentreY, joystickDirn, joystickDist, joystickPos, relX, relY;
    ballCentreX = this.joystickSize / 2;
    ballCentreY = this.joystickSize / 2;
    joystickPos = $(".sqJoystick").offset();
    relX = event.pageX - joystickPos.left;
    relY = event.pageY - joystickPos.top;
    joystickDirn = Math.atan2(relY - ballCentreY, relX - ballCentreX) * 180 / Math.PI;
    joystickDist = Math.sqrt((relY - ballCentreY) * (relY - ballCentreY) + (relX - ballCentreX) * (relX - ballCentreX));
    this.directionCallback(joystickDirn, joystickDist);
  };

  SpideyAppUI.prototype.touchMoveJoystick = function(event) {
    var pagePos;
    event.preventDefault();
    if (event.originalEvent.touches.length === 1) {
      pagePos = {
        pageX: event.originalEvent.touches[0].pageX,
        pageY: event.originalEvent.touches[0].pageY
      };
      this.mouseMoveJoystick(pagePos);
    }
  };

  SpideyAppUI.prototype.touchStartJoystick = function(event) {
    event.preventDefault();
  };

  SpideyAppUI.prototype.showGameUI = function(showIt) {
    $("#gamebuttons").show();
    this.showGameBackdrop();
    this.showGamePad(200, 100);
  };

  SpideyAppUI.prototype.showGamePad = function(tlx, tly) {
    $("#gamebuttons").append("<div class=\"sqJoystick\" style=\"display:block; opacity:1;\">\n	<div class=\"sqJoystickImg\" style=\"position:absolute;\" >\n		<img width=\"100%\" height=\"100%\" src=\"img/joystickbase.png\"></img>\n	</div>\n	<div id=\"sqJoystickBall\" style=\"position:absolute;\" >\n		<img width=\"50%\" height=\"50%\" src=\"img/joystickball.png\" style=\"margin-top:30%;margin-left:31%\"></img>\n	</div>\n</div>");
    $(".sqJoystick").on("mousemove", this.mouseMoveJoystick);
    $(".sqJoystick").on("touchstart", this.touchStartJoystick);
    $(".sqJoystick").on("touchmove", this.touchMoveJoystick);
  };

  SpideyAppUI.prototype.showGameBackdrop = function() {
    var link, linkIdx, _i, _j, _len, _len1, _ref, _ref1;
    this.canvas.fillStyle = "black";
    this.canvas.fillRect(0, 0, this.canvasWidth, this.canvasHeight);
    this.canvas.lineWidth = this.canvasHeight / 30;
    _ref = this.spideyWall.getLinks();
    for (linkIdx = _i = 0, _len = _ref.length; _i < _len; linkIdx = ++_i) {
      link = _ref[linkIdx];
      this.canvas.beginPath();
      this.canvas.moveTo(link.xSource * this.scaleFactorX, link.ySource * this.scaleFactorY);
      this.canvas.lineTo(link.xTarget * this.scaleFactorX, link.yTarget * this.scaleFactorY);
      this.canvas.strokeStyle = "blue";
      this.canvas.stroke();
    }
    this.canvas.lineWidth = this.canvasHeight / 50;
    _ref1 = this.spideyWall.getLinks();
    for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
      link = _ref1[_j];
      this.canvas.beginPath();
      this.canvas.moveTo(link.xSource * this.scaleFactorX, link.ySource * this.scaleFactorY);
      this.canvas.lineTo(link.xTarget * this.scaleFactorX, link.yTarget * this.scaleFactorY);
      this.canvas.strokeStyle = "black";
      this.canvas.stroke();
    }
  };

  SpideyAppUI.prototype.showGameOver = function() {
    var popHig, popLeft, popTop, popWid;
    popWid = this.canvasWidth / 2;
    popHig = this.canvasHeight / 10;
    popTop = this.canvasTop + this.canvasHeight / 3 - popHig / 2;
    popLeft = this.canvasLeft + this.canvasWidth / 2 - popWid / 2;
    $("body").append("<div id=\"gameoverpopup\" style=\"display:block; opacity:1;\n		        position: absolute;\n		        width: " + popWid + "px;\n		        height: " + popHig + "px;\n		        background: #000000;\n		        color: yellow;\n		        border: 10px solid yellow;\n		        border-radius: 10px;\n		        padding: 15px 17px;\n		        margin: 10% auto;\n		        top: " + popTop + "px;\n		        left: " + popLeft + "px;\">\n	<div style=\"text-align: center\">\n		<img width=\"100%\" height=\"100%\" src=\"img/gameoverplayagain.png\" style=\"\"></img>\n	</div>\n</div>");
    $("#gameoverpopup").on("click", (function(_this) {
      return function() {
        $("#gameoverpopup").remove();
        return _this.restartCallback();
      };
    })(this));
  };

  return SpideyAppUI;

})();
